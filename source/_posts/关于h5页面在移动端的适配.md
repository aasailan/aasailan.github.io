---
title: 关于h5页面在移动端的适配
date: 2018-07-19 19:05:18
categories:
  - css系列
tags: 
  - 前端
  - h5
  - 移动端
  - css
comments: false
---
最近为了学习egg，就用egg框架在重构一个微信小程序商城的后台的。这个项目几乎占用了我所有的业余时间，不过也算收获颇丰。现在还没做完，等做完后会发到仓库里面。也因为这个，很久没有发过blog。今天这篇blog的主题是h5页面在移动端的适配问题，这也算是自己做了一年的vue开发在这方面的一个总结吧。

## 适配目标
首先移动端的屏幕适配要达到的目标主要是以下两点：  
1. 如何在不同比例的屏幕下实现各种元素的等比缩放，保持布局上的观感
2. 如何在retina屏幕下保证图片的清晰显示，以及在retina屏幕下显示 **物理像素** 级别的1px线

从前端工程的管理与实现上又主要分为两个部分：  
1. 设计师的设计规范、标注稿、切图的交付规范。
2. 前端的具体适配方案以及代码实现。

## 设计师规范
首先谈谈设计师的设计规范、标注稿、切图规范。   
1. 设计稿用375px宽度（iphone6的逻辑像素宽度），但是给前端的标注稿使用750px宽度（iphone6的物理像素宽度）。    
2. 所有切图按设计稿的3倍进行放大（就是切图稿是1125px宽度），这是为了保证dpr为3的iphoneX的高清屏，并且也覆盖到了1080p的屏幕。
3. 3倍放大后的切图上传到[**tinypng**](https://tinypng.com/)进行压缩，然后再使用。
   
以上是设计师需要遵守的约定。这里推荐一下 https://lanhuapp.com 这个网站。设计师将自己做好的设计稿上传，前端工程师可以非常方便的获取到各种标注信息以及切图^^

## 前端实现
以下是前端的具体工程实现。这里又分为两种方案，两种方案都是参考手淘团队 ^^：
1. [**flexible方案**](http://www.w3cplus.com/mobile/lib-flexible-for-html5-layout.html)
2. [**vw方案**](https://www.w3cplus.com/mobile/vw-layout-in-vue.html)

在介绍两个方案之前，有一些关于移动端屏幕的基础知识需要了解：
* 设备像素：屏幕的物理像素，平时说的1080p就是指手机的设备像素宽度达到了1080个像素点。iphone6的设备像素宽度是750px。
* 逻辑像素（css像素）：软件能操作的像素，在css代码中写上1px代表的像素。iphone6的逻辑像素宽度是375px。
* dpr（设备像素比）：dpr = 物理像素 / 设备独立像素。iphone6的dpr = 750 / 375 = 2。
* viewport：浏览器视图属性，具体参见[**viewports剖析**](http://www.w3cplus.com/css/viewports.html)这篇文章

#### flexible方案
先来介绍flexible方案，flexible是手淘团队以前的移动端适配方案。其主要的思想有三点：   
1. 通过flexible.js来根据手机浏览器信息动态修改dpr以及root-font-size（关于dpr的知识请自行了解）
2. 根据dpr的值来修改缩放viewport，进而实现显示 **物理像素** 级别的 1px 细线
3. 使用less或者scss等css拓展语言，将代码中的px转换为rem，实现等比缩放

flexible适配的优点：  
1. rem的浏览器兼容性很好，详情见：https://caniuse.com/#search=rem
2. 淘宝提供了flexible.js的[**cdn加速**](http://g.tbcdn.cn/mtb/lib-flexible/0.3.4/??flexible_css.js,flexible.js)，引用非常方便

flexible适配的缺点：
1. flexible.js仅对ios进行了dpr的检测判断，android因为dpr分布过于碎片化，所以统一设置为dpr等于1。这导致在android的retina屏幕上面，实际上没有对viewport进行缩放，所以无法显示 **物理像素** 级别的 1px 细线。
2. flexible方案由于缩放了viewport，所以会导致一些意想不到的问题，比如微信浏览器中无法长按二维码进行扫面，详见：https://github.com/amfe/lib-flexible/issues/99  flexible官方github的issue中还有各种神奇的bug

前端实现的关键步骤：   
1. 在html页面的head标签内引用淘宝提供flexible.js文件，cdn地址为：http://g.tbcdn.cn/mtb/lib-flexible/0.3.4/??flexible_css.js,flexible.js    
2. 在使用less或者scss编写针对font-size的mixin，让font-size在不同dpr下面使用不同的值，保证不同dpr屏幕上字体大小的相对一致
3. 使用less或者scss的数学计算将px转换为rem。规定标注稿为750px的情况下，1rem=750px / 100 * 10=75px。（至于为什么这样规定，请参考[**使用Flexible实现手淘H5页面的终端适配**](http://www.w3cplus.com/mobile/lib-flexible-for-html5-layout.html)^^）

#### vw方案
vw适配的主要思想是：
1. 利用css3新单位vw的特性来实现等比缩放（vw的知识请自行了解）
2. 利用border-image、background-image加svg图片的方式来显示 **物理像素** 级别的1px细线

工程实现上主要有两个要点：
1. 使用postcss-px-to-viewport插件将px自动转换为vw单位
2. 使用postcss-write-svg插件可以在css中定义svg图片

vw适配的优点：
1. 无论是ios还是android，都能实现较好的等比缩放
2. 无论是ios还是android，都能较好的显示 **物理像素** 级别的1px细线

vw适配的缺点：
1. vw的浏览器兼容性不如rem好，详见：https://caniuse.com/#search=vw

前端实现的关键步骤：
1. 借助postcss-px-to-viewport将px转换为vw单位（包括元素的宽高，内外边距，字体大小），1px边框分割线显示除外。
2. 借助postcss-write-svg插件以及 background-image、border-image属性实现**物理像素**级别的1px显示。

## demo示例
最后才是重点，**附上我写的demo项目仓库！！**，可以在这个项目中获得参考：https://github.com/aasailan/h5-mobile-layout
^^
